C251 COMPILER V5.60.0,  IO                                                                 25/04/24  01:27:45  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE IO
OBJECT MODULE PLACED IN IO.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE IO.c XSMALL OPTIMIZE(9,SPEED) BROWSE DEBUG TABS(2) 

stmt  level    source

    1          #include "IO.h"
    2          #include "time.h"
    3          #include "DATA.h"
    4          #include "logic.h"
    5          #include "OLED.h"
    6          //******************************************************************************
    7          //*
    8          //*     OLED_POW  打开OLED屏幕供电，00-5V 01-5.5V 02-6V 03-6.5V
    9          //*
   10          //******************************************************************************
   11          extern u16 Sleep_Queue_task[Sleep_queue_num];
   12          extern u16 dat00[System_data_num];
   13          //========================================================================
   14          // 函数: void OLED_POW(u8 dat)
   15          // 描述: OLED供电启动 0~3 为5/6/7/8V选择
   16          // 参数: 
   17          // 返回:
   18          // 版本: V1.0 2023.02.05
   19          //========================================================================
   20          void OLED_POW(u8 dat)
   21          {
   22   1          P53 = 1;
   23   1          P5M0 &= 0xf7; //p54双向
   24   1          P5M1 &= 0xf7;
   25   1          P05 = ~(dat & 0x01);
   26   1          P06 = ~(dat & 0x02);
   27   1      }
   28          //========================================================================
   29          // 函数: void OLED_POW_LOW()
   30          // 描述: OELD供电关闭
   31          // 参数: 
   32          // 返回:
   33          // 版本: V1.0 2023.02.05
   34          //========================================================================
   35          void OLED_POW_LOW()
   36          {
   37   1          P53 = 0;
   38   1          P5M0 |= 0x08;
   39   1          P5M1 |= 0x08;
   40   1          P05 = 1;
   41   1          P06 = 1;
   42   1      }
   43          //========================================================================
   44          // 函数: void RESET54()
   45          // 描述: P54位复位引脚
   46          // 参数: 
   47          // 返回:
   48          // 版本: V1.0 2023.02.05
   49          //========================================================================
   50          void RESET54()
   51          {
   52   1          P5M0 &= 0xed; //p54双向
   53   1          P5M1 &= 0xed;
   54   1          P54RST = 1;
   55   1      }
   56          //========================================================================
   57          // 函数: void Clock_INT()
   58          // 描述: RTC中断初始化
   59          // 参数: 
C251 COMPILER V5.60.0,  IO                                                                 25/04/24  01:27:45  PAGE 2   

   60          // 返回:
   61          // 版本: V1.0 2023.02.05
   62          //========================================================================
   63          void Clock_INT()
   64          {
   65   1      //      P5M0 &= 0xfe; //p54双向
   66   1      //      P5M1 &= 0xfe;
   67   1          P50 = 1;
   68   1          P5INTE |= 0x01;//允许端口中断
   69   1          P5IM1 =  0x00;//下降沿中断
   70   1          P5IM0 =  0x00;
   71   1          P5WKUE |= 0x01;//允许掉电唤醒
   72   1      
   73   1      
   74   1      //      P5M0 &= 0xfe; //p54双向
   75   1      //      P5M1 &= 0xfe;
   76   1      
   77   1      //      P5M0 &= 0xFB; //初始化电池电压检测MOS控制开关
   78   1      //      P5M1 &= 0xFB; //
   79   1      }
   80          
   81          
   82          
   83          
   84          
   85          
   86          //========================================================================
   87          // 函数: void key_int()
   88          // 描述: 按键初始化
   89          // 参数: 
   90          // 返回:
   91          // 版本: V1.0 2023.02.05
   92          //========================================================================
   93          
   94          void key_int()
   95          {
   96   1          //+
   97   1      //  P4M0 &= 0x9f;
   98   1      //  P4M1 &= 0x9f;
   99   1      
  100   1          P4INTE |= 0x60;//允许端口中断
  101   1          P4IM1 &=  0x9f;//下降沿中断
  102   1          P4IM0 &=  0x9f;
  103   1      
  104   1          P4WKUE |= 0x60;//允许掉电唤醒
  105   1      
  106   1      //  P2M0 &= 0x3f;
  107   1      //  P2M1 &= 0x3f;
  108   1      
  109   1          P2INTE |= 0xC0;//允许端口中断
  110   1          P2IM1 &=  0x3f;//下降沿中断
  111   1          P2IM0 &=  0x3f;
  112   1      
  113   1          P2WKUE |= 0xC0;//允许掉电唤醒
  114   1      
  115   1      }
  116          
  117          //========================================================================
  118          // 函数: void Buzzer_Open()
  119          // 描述: 蜂鸣器打开
  120          // 参数: 
  121          // 返回:
  122          // 版本: V1.0 2023.02.05
  123          //========================================================================
  124          void Buzzer_Open()
  125          {
C251 COMPILER V5.60.0,  IO                                                                 25/04/24  01:27:45  PAGE 3   

  126   1          P4M0 |= 0x01;
  127   1          P4M1 &= 0xFE;
  128   1          P40=1;
  129   1      }
  130          //========================================================================
  131          // 函数: void Buzzer_Close()
  132          // 描述: 蜂鸣器关闭
  133          // 参数: 
  134          // 返回:
  135          // 版本: V1.0 2023.02.05
  136          //========================================================================
  137          void Buzzer_Close()
  138          {
  139   1          P4M0 |= 0x01;
  140   1          P4M1 |= 0x01;
  141   1          P40=0;
  142   1      }
  143          
  144          
  145          //========================================================================
  146          // 函数: void Buzzer_falg_0020()
  147          // 描述: 蜂鸣器任务，关闭蜂鸣器输出
  148          // 参数: 
  149          // 返回:
  150          // 版本: V1.0 2023.02.05
  151          //========================================================================
  152          void Buzzer_falg_0020()
  153          {
  154   1          if(Sleep_Queue_task[0] & 0x0020)
  155   1          {
  156   2              dat00[0x0005] &= 0xFFFD;
  157   2              if(dat00[0x0005] == 0)  Buzzer_Close();
  158   2              Sleep_Queue_task[0] &=~0x0020;
  159   2          }
  160   1      }
  161          
  162          //========================================================================
  163          // 函数: void Battery_ON_ON()
  164          // 描述: 打开电池电压检测MOS控制开关
  165          // 参数: 
  166          // 返回:
  167          // 版本: V1.0 2023.02.05
  168          //========================================================================
  169          void Battery_ON_ON()
  170          {
  171   1          P52 = 1;
  172   1          P5M0 |= 0x04; //初始化电池电压检测MOS控制开关
  173   1          P5M1 &= ~0x04; //
  174   1      }
  175          //========================================================================
  176          // 函数: void Battery_ON_OFF()
  177          // 描述: 关闭、初始化电池电压检测MOS控制开关
  178          // 参数: 
  179          // 返回:
  180          // 版本: V1.0 2023.02.05
  181          //========================================================================
  182          void Battery_ON_OFF()
  183          {
  184   1      
  185   1          P5M0 |= 0x04; //初始化电池电压检测MOS控制开关
  186   1          P5M1 |= 0x04; //
  187   1          P52 = 0;
  188   1      }
  189          
  190          
  191          
C251 COMPILER V5.60.0,  IO                                                                 25/04/24  01:27:45  PAGE 4   

  192          
  193          
  194          //========================================================================
  195          // 函数: void ICacheOn(void)
  196          // 描述: 打开ICACHE功能，STC官方例程
  197          // 参数: 
  198          // 返回:
  199          // 版本: V1.0 2023.02.05
  200          //========================================================================
  201          void ICacheOn(void)     //打开ICACHE功能
  202          {
  203   1          bit fEA;
  204   1      
  205   1          if(WTST > 0)
  206   1          {
  207   2              fEA = EA;
  208   2              EA = 0;         //关闭中断，防止写触发命令序列中途产生中断
  209   2              _nop_();
  210   2              _nop_();
  211   2              NOP40();
  212   2              TA = 0xaa;      //写入触发命令序列1
  213   2              //此处不能有其他任何指令
  214   2              TA = 0x55;      //写入触发命令序列2
  215   2              //此处不能有其他任何指令
  216   2              ICHECR = 0x01;  //写保护暂时关闭，可以修改ICHECR中的EN位
  217   2              //EN为再次进入写保护状态
  218   2              _nop_();
  219   2              _nop_();
  220   2              NOP40();
  221   2              EA = fEA;
  222   2          }
  223   1      }
  224          //========================================================================
  225          // 函数: ICacheOff(void)
  226          // 描述: 关闭ICACHE功能，STC官方例程
  227          // 参数: 
  228          // 返回:
  229          // 版本: V1.0 2023.02.05
  230          //========================================================================
  231          void ICacheOff(void)//关闭ICACHE功能
  232          {
  233   1          bit fEA;
  234   1      
  235   1          fEA = EA;
  236   1          EA = 0;         //关闭中断，防止写触发命令序列中途产生中断
  237   1          _nop_();
  238   1          _nop_();
  239   1          NOP40();
  240   1          TA = 0xaa;      //写入触发命令序列1
  241   1          //此处不能有其他任何指令
  242   1          TA = 0x55;      //写入触发命令序列2
  243   1          //此处不能有其他任何指令
  244   1          ICHECR = 0x00;  //写保护暂时关闭，可以修改ICHECR中的EN位
  245   1          //EN位再次进入写保护状态
  246   1          _nop_();
  247   1          _nop_();
  248   1          NOP40();
  249   1          EA = fEA;
  250   1      }
  251          
  252          
  253          
  254          //========================================================================
  255          // 函数: IO_Init(void)
  256          // 描述: IO初始化
  257          // 参数: 
C251 COMPILER V5.60.0,  IO                                                                 25/04/24  01:27:45  PAGE 5   

  258          // 返回:
  259          // 版本: V1.0 2023.02.05
  260          //========================================================================
  261          void IO_Init(void)
  262          {
  263   1      
  264   1      //*********************P0区*******************************
  265   1      //
  266   1      //  BMC050 DRDYO中断+  KEYSET + KEY+ 设置为双向口 默认高电平
  267   1      //
  268   1      //  （双向）P07 SPL06_INT        （开漏）P06 OLEDV1       （开漏）P05 OLEDV2    （高阻）P0
             -4 BATTERY（电池ADC采样脚）   （高阻）P03 ADC6（充电电流）   （开漏）PP02 EN（锂电池充电EN） 
             -  （高阻）P01 GHRG   （开漏）PP00 VIN/2
  269   1      
  270   1          P0M0 = 0x65;
  271   1          P0M1 = 0x7f;
  272   1      
  273   1      //*********************P4区*******************************
  274   1      //  P47 DRDYO        P46 KEYSET       P45 KEY+    P44 悬空   P43 悬空   P42 悬空   P41 悬空   P40 
             -CCP0_EN（蜂鸣器控制）
  275   1          P4M0 = 0x1f;
  276   1          P4M1 = 0x1f;
  277   1          Buzzer_Close();
  278   1      
  279   1      
  280   1      //*********************P1区*******************************
  281   1      //  （双向）P17 INT3O        （开漏）P16 悬空       （双向）P15 SCL    （双向）P14 SDA  
             - （双向）P13 INT2O    （开漏）P12   （开漏）P11 BH_INT   （开漏）P10 悬空
  282   1          P1M0 = 0x47;
  283   1          P1M1 = 0x47;
  284   1      //    SCK = 0;
  285   1          P1PU = 0x30;//IIC上拉电阻
  286   1      
  287   1      
  288   1      
  289   1      //*********************P3区*******************************
  290   1      //  （双向）P37 INT3（BMC050）        （开漏）P36 悬空       （开漏）P35 悬空    （双
             -）P34 SW360   （开漏）P33 悬空    （开漏）P32 悬空     （开漏）P31 TX   （开漏）P30 RX
  291   1          P3M0 = 0x6f;
  292   1          P3M1 = 0x6f;
  293   1      
  294   1      //*********************P5区*******************************
  295   1      //  （开漏）P57         （开漏）P56        （开漏）P55     （双向）P54 RSET   （开漏）
             -P53 5VEN    （开漏）P52 BATTERY_ON     （开漏）P51 TEXT  （双向）P50 SQW（1Hz）
  296   1          P5M0 = 0xee;
  297   1          P5M1 = 0xee;
  298   1      
  299   1      
  300   1      //*********************P2区*******************************
  301   1      //  （双向）P27  KEY-       （双向）P26  KEYMODE      （推挽）P25 SCLK    （开漏）P24 悬
             -   （推挽）P23 MOSI    （开漏）P22 CS     （双向）P21 DC  （双向）P20 RES
  302   1          CS =0;
  303   1          P2M0 = 0x3c;
  304   1          P2M1 = 0x14;
  305   1      
  306   1          P2SR = 0xd7;
  307   1          P2DR = 0xd7;
  308   1      
  309   1      
  310   1      
  311   1          P6M0 = 0xff;
  312   1          P6M1 = 0xff;
  313   1      
  314   1          P7M0 = 0xff;
  315   1          P7M1 = 0xff;
  316   1      
C251 COMPILER V5.60.0,  IO                                                                 25/04/24  01:27:45  PAGE 6   

  317   1          //输入寄存器使能
  318   1          P0IE=0x1b;
  319   1          P1IE=0x30;
  320   1          P2IE=0xc0;
  321   1          P3IE=0x13;//0x10
  322   1          P4IE=0x60;
  323   1          P5IE=0x11;
  324   1          P6IE=0x00;
  325   1          P7IE=0x00;
  326   1      
  327   1      
  328   1      }
  329          
  330          
  331          
  332          
  333          
  334          
  335          
  336          
  337          
  338          
  339          
  340          
  341          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       637     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------          2
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
